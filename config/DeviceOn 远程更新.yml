app:
  description: ''
  icon: ğŸ¤–
  icon_background: '#FFEAD5'
  mode: workflow
  name: DeviceOn è¿œç¨‹æ›´æ–°
  use_icon_as_answer_icon: false
dependencies:
- current_identifier: null
  type: marketplace
  value:
    marketplace_plugin_unique_identifier: langgenius/azure_openai:0.0.12@a8d5448083aededa394d5940f878f6151f4a472e77766222e654840c74d10287
kind: app
version: 0.1.5
workflow:
  conversation_variables: []
  environment_variables:
  - description: ''
    id: a23a6c5c-6270-422c-b427-e6a601484b3a
    name: filter_error
    selector:
    - env
    - filter_error
    value: app-akKVIu2IfSDr8rc6jY2rpUww
    value_type: string
  - description: ''
    id: 95e5a0fd-e54c-45d3-8105-86f37d9ff218
    name: path
    selector:
    - env
    - path
    value: http://172.21.161.126/v1/workflows/run
    value_type: string
  features:
    file_upload:
      allowed_file_extensions:
      - .JPG
      - .JPEG
      - .PNG
      - .GIF
      - .WEBP
      - .SVG
      allowed_file_types:
      - image
      allowed_file_upload_methods:
      - local_file
      - remote_url
      enabled: false
      fileUploadConfig:
        audio_file_size_limit: 50
        batch_count_limit: 5
        file_size_limit: 15
        image_file_size_limit: 10
        video_file_size_limit: 100
        workflow_file_upload_limit: 10
      image:
        enabled: false
        number_limits: 3
        transfer_methods:
        - local_file
        - remote_url
      number_limits: 3
    opening_statement: ''
    retriever_resource:
      enabled: true
    sensitive_word_avoidance:
      enabled: false
    speech_to_text:
      enabled: false
    suggested_questions: []
    suggested_questions_after_answer:
      enabled: false
    text_to_speech:
      enabled: false
      language: ''
      voice: ''
  graph:
    edges:
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: start
        targetType: http-request
      id: 1744019627790-source-1744185766139-target
      source: '1744019627790'
      sourceHandle: source
      target: '1744185766139'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: http-request
        targetType: code
      id: 1744185766139-source-1744185817604-target
      source: '1744185766139'
      sourceHandle: source
      target: '1744185817604'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: llm
      id: 1744185817604-source-1744186341974-target
      source: '1744185817604'
      sourceHandle: source
      target: '1744186341974'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: code
      id: 1744186341974-source-1744190704175-target
      source: '1744186341974'
      sourceHandle: source
      target: '1744190704175'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: if-else
      id: 1744254606128-source-1744255072161-target
      source: '1744254606128'
      sourceHandle: source
      target: '1744255072161'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: if-else
        targetType: end
      id: 1744255072161-true-1744255120169-target
      source: '1744255072161'
      sourceHandle: 'true'
      target: '1744255120169'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: if-else
        targetType: http-request
      id: 1744255072161-94f2aeb0-7641-43af-9c3b-ab7b51e269a3-1744255571899-target
      source: '1744255072161'
      sourceHandle: 94f2aeb0-7641-43af-9c3b-ab7b51e269a3
      target: '1744255571899'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: http-request
        targetType: code
      id: 1744255571899-source-1744255807610-target
      source: '1744255571899'
      sourceHandle: source
      target: '1744255807610'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: http-request
      id: 1744190704175-source-1744262385871-target
      source: '1744190704175'
      sourceHandle: source
      target: '1744262385871'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: http-request
        targetType: code
      id: 1744262385871-source-1744254606128-target
      source: '1744262385871'
      sourceHandle: source
      target: '1744254606128'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInLoop: false
        sourceType: if-else
        targetType: code
      id: 1744255072161-false-1744255807610-target
      source: '1744255072161'
      sourceHandle: 'false'
      target: '1744255807610'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: http-request
      id: 1744255807610-source-1744265799521-target
      source: '1744255807610'
      sourceHandle: source
      target: '1744265799521'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: http-request
        targetType: code
      id: 1744265799521-source-1744265933431-target
      source: '1744265799521'
      sourceHandle: source
      target: '1744265933431'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: end
      id: 1744265933431-source-1744268747197-target
      source: '1744265933431'
      sourceHandle: source
      target: '1744268747197'
      targetHandle: target
      type: custom
      zIndex: 0
    nodes:
    - data:
        desc: ''
        selected: false
        title: å¼€å§‹
        type: start
        variables:
        - label: api
          max_length: 256
          options: []
          required: true
          type: text-input
          variable: api
        - label: token
          max_length: 256
          options: []
          required: true
          type: text-input
          variable: token
        - label: timezone
          max_length: 256
          options: []
          required: true
          type: text-input
          variable: timezone
        - label: question
          max_length: 80000
          options: []
          required: true
          type: paragraph
          variable: question
        - label: content
          max_length: 80000
          options: []
          required: true
          type: paragraph
          variable: content
        - label: type
          max_length: 80000
          options: []
          required: true
          type: paragraph
          variable: type
      height: 220
      id: '1744019627790'
      position:
        x: 30
        y: 310
      positionAbsolute:
        x: 30
        y: 310
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        authorization:
          config: null
          type: no-auth
        body:
          data: []
          type: none
        desc: ''
        headers: Authorization:{{#1744019627790.token#}}
        method: get
        params: ''
        retry_config:
          max_retries: 3
          retry_enabled: true
          retry_interval: 100
        selected: false
        timeout:
          max_connect_timeout: 0
          max_read_timeout: 0
          max_write_timeout: 0
        title: è·å–è®¾å¤‡åˆ—è¡¨
        type: http-request
        url: '{{#1744019627790.api#}}/walle/ai/device/list'
        variables: []
      height: 139
      id: '1744185766139'
      position:
        x: 334
        y: 310
      positionAbsolute:
        x: 334
        y: 310
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        code: "function convertToTimeZone(timezone) {\n  // æ£€æŸ¥æ ¼å¼æ˜¯å¦ä»¥ \"UTC\" å¼€å¤´\n \
          \ if (!timezone.startsWith(\"UTC\")) {\n    throw new Error(\"æ—¶åŒºæ ¼å¼å¿…é¡»ä»¥ 'UTC'\
          \ å¼€å¤´\");\n  }\n  // è·å–ç¬¦å·å’Œå°æ—¶ã€åˆ†é’Ÿéƒ¨åˆ†\n  const sign = timezone[3]; // '+' æˆ– '-'\n\
          \  if (sign !== '+' && sign !== '-') {\n    throw new Error(\"æ— æ•ˆçš„æ—¶åŒºæ ¼å¼\"\
          );\n  }\n  const hourStr = timezone.substr(4, 2);\n  const minuteStr = timezone.substr(7,\
          \ 2);\n  const offsetHours = parseInt(hourStr, 10);\n  const offsetMinutes\
          \ = parseInt(minuteStr, 10);\n  // è®¡ç®—æ€»åç§»åˆ†é’Ÿæ•°ï¼ˆæ­£å€¼ä»£è¡¨æ¯” UTC æ™šï¼Œè´Ÿå€¼ä»£è¡¨æ¯” UTC æ—©ï¼‰\n \
          \ let totalOffset = offsetHours * 60 + offsetMinutes;\n  if (sign === '-')\
          \ {\n    totalOffset = -totalOffset;\n  }\n  // å½“å‰çš„ UTC æ¯«ç§’æ•°ï¼ˆDate.now() è¿”å›çš„æ˜¯è‡ª1970å¹´1æœˆ1æ—¥\
          \ UTC ä»¥æ¥çš„æ¯«ç§’æ•°ï¼‰\n  const nowMs = Date.now();\n  // ç›®æ ‡æ—¶åŒºçš„æ¯«ç§’æ•° = å½“å‰ UTC æ¯«ç§’æ•° +\
          \ æ—¶åŒºåç§»åˆ†é’Ÿæ•°è½¬æ¢ä¸ºæ¯«ç§’\n  const targetMs = nowMs + totalOffset * 60000;\n  const\
          \ targetDate = new Date(targetMs);\n  // ä½¿ç”¨ getUTC* æ–¹æ³•æ¥æå–ç›®æ ‡æ—¶åŒºçš„å„éƒ¨åˆ†\n  const\
          \ year = targetDate.getUTCFullYear();\n  const month = String(targetDate.getUTCMonth()\
          \ + 1).padStart(2, '0'); // æœˆä»½ä» 0 å¼€å§‹\n  const day = String(targetDate.getUTCDate()).padStart(2,\
          \ '0');\n  const hours = String(targetDate.getUTCHours()).padStart(2, '0');\n\
          \  const minutes = String(targetDate.getUTCMinutes()).padStart(2, '0');\n\
          \  const seconds = String(targetDate.getUTCSeconds()).padStart(2, '0');\n\
          \n  return `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;\n}\n\
          function main({body, timezone}) {\n  const res = JSON.parse(body)\n  const\
          \ device = Array.isArray(res?.rows) ? Array.from(res.rows).map(o => {\n\
          \    return {\n      id: o.deviceId,\n      nm: o.deviceName,\n      os:\
          \ o.deviceOs,\n      ip: o.deviceIp,\n      l1: o.labelDeviceName1,\n  \
          \    l2: o.labelDeviceName2,\n      st: o.onlineStatus,\n      tz: o.timezone,\n\
          \      hw: o.hardwareError,\n      sw: o.softwareError,\n      bt: o.batteryError,\n\
          \      pp: o.peripheralsError,\n      sc: o.securityError,\n    }\n  })\
          \ : []\n  const id = Array.from(new Set(device.map(o => o.id).filter(o =>\
          \ !!o)))\n  const name = Array.from(new Set(device.map(o => o.nm).filter(o\
          \ => !!o)))\n  const ip = Array.from(new Set(device.map(o => o.ip).filter(o\
          \ => !!o)))\n  const label1 = Array.from(new Set(device.map(o => o.l1).filter(o\
          \ => !!o)))\n  const label2 = Array.from(new Set(device.map(o => o.l2).filter(o\
          \ => !!o)))\n  const date = convertToTimeZone(timezone);\n  return {\n \
          \   device: JSON.stringify(device),\n    id: JSON.stringify(id, null, 2),\n\
          \    name: JSON.stringify(name, null, 2),\n    ip: JSON.stringify(ip, null,\
          \ 2),\n    label1: JSON.stringify(label1, null, 2),\n    label2: JSON.stringify(label2,\
          \ null, 2),\n    date,\n  }\n}\n"
        code_language: javascript
        desc: ''
        outputs:
          date:
            children: null
            type: string
          device:
            children: null
            type: string
          id:
            children: null
            type: string
          ip:
            children: null
            type: string
          label1:
            children: null
            type: string
          label2:
            children: null
            type: string
          name:
            children: null
            type: string
        selected: false
        title: å¤„ç†è®¾å¤‡åˆ—è¡¨
        type: code
        variables:
        - value_selector:
          - '1744185766139'
          - body
          variable: body
        - value_selector:
          - '1744019627790'
          - timezone
          variable: timezone
      height: 54
      id: '1744185817604'
      position:
        x: 638
        y: 310
      positionAbsolute:
        x: 638
        y: 310
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        context:
          enabled: true
          variable_selector:
          - '1744019627790'
          - question
        desc: ''
        model:
          completion_params:
            temperature: 0
          mode: chat
          name: gpt-4o-mini
          provider: langgenius/azure_openai/azure_openai
        prompt_template:
        - id: 3f8ae497-7ec1-42e3-be0c-d2e3c9f74e81
          role: system
          text: "# ä¿¡æ¯æå–æç¤ºè¯\n\n## è¾“å…¥æ•°æ®\n- `{query}`: `{{#context#}}`\n\n---\n\n## è¯­è¨€ç¡®å®š\n\
            æ ¹æ®`{query}`æ–‡æœ¬è¯­è¨€è‡ªåŠ¨ç¡®å®š `lang` å€¼ï¼Œ**è¯·æ³¨æ„åŒºåˆ†ç®€ä½“ä¸­æ–‡ä¸ç¹é«”ä¸­æ–‡**ï¼š\n- ç®€ä½“ä¸­æ–‡ â†’ `zh-CN`\n-\
            \ ç¹é«”ä¸­æ–‡ â†’ `zh-TW`\n- è‹±æ–‡ â†’ `en-US`\n- æ—¥æ–‡ â†’ `ja-JP`\n\n---\n\n## å¤„ç†æµç¨‹\n\n\
            ### è¯­è¨€è‡ªé€‚åº”\nå¦‚æœ`{query}`æ–‡æœ¬è¯­è¨€ä¸ºéç®€ä½“ä¸­æ–‡ï¼Œè¯·è‡ªåŠ¨å°†ä¸‹æ–‡ä¸­çš„ç®€ä½“ä¸­æ–‡æç¤ºé€»è¾‘ï¼Œåº”ç”¨äº`lang`è¯­è¨€åœºæ™¯\n\n---\n\
            \n### ä»»åŠ¡ç±»å‹åˆ†æ\n\n- æ ¹æ®`{query}`å†…å®¹ï¼Œç¡®å®šä»»åŠ¡ç±»å‹ï¼š\n    - **è½¯ä»¶å®‰è£…** â†’ `actionCode:\
            \ 90021`ï¼ˆåŒ¹é…`è½¯ä»¶å®‰è£…`ã€`è½¯ä»¶æ›´æ–°`ã€`è½¯ä»¶å‡çº§`ï¼‰\n    - **è½¯ä»¶å¸è½½** â†’ `actionCode: 90022`ï¼ˆåŒ¹é…`è½¯ä»¶å¸è½½`ã€`è½¯ä»¶ç§»é™¤`ã€`è½¯ä»¶åˆ é™¤`ï¼‰\n\
            \    - **æ‰§è¡Œè„šæœ¬** â†’ `actionCode: 90071`ï¼ˆåŒ¹é…`æ‰§è¡Œè„šæœ¬`ã€`è¿è¡Œè„šæœ¬`ï¼‰\n    - **ä¼ è¾“æ¡£æ¡ˆ**\
            \ â†’ `actionCode: 90081`ï¼ˆåŒ¹é…`ä¼ è¾“æ¡£æ¡ˆ`ã€`å‘é€æ¡£æ¡ˆ`ï¼‰\n\n- å¦‚æœ`{query}`æ–‡æœ¬ä¸­åŒ¹é…åˆ°è¯¸å¦‚`è§¦å‘å‹`ã€`è§¦å‘å‹ä»»åŠ¡`ç­‰ç±»ä¼¼æè¿°æ—¶åˆ™è®¾ç½®\
            \ `is_trigger = true`\n\n---\n\n### ä»»åŠ¡æ‰§è¡Œæ—¶é—´åˆ†æ\n\n- **ä¸Šçº¿åæ‰§è¡Œ**\n    - è‹¥`{query}`åŒ¹é…åˆ°\
            \ `ä¸Šçº¿åæ‰§è¡Œ`ã€`å‘å¸ƒåè¿è¡Œ` ç­‰ç±»ä¼¼æè¿° â†’ `scheduleType = \"ONLINE\"`\n\n- **å»¶è¿Ÿæ‰§è¡Œ**\n\
            \    - è‹¥`{query}`åŒ¹é…åˆ° `Xåˆ†é’Ÿåæ‰§è¡Œ`ã€`æŒ‡å®šæ—¶é—´æ‰§è¡Œ` ç­‰ç±»ä¼¼æ˜¾å¼æ—¶é—´æè¿° â†’\n        - `scheduleType\
            \ = \"CRON ONCE\"`\n        - `scheduleCron = è®¡ç®—åçš„ç»å¯¹æ—¶é—´ï¼ˆæ ¼å¼ï¼šYYYY/MM/DD HH:mm:ssï¼Œå‚è€ƒå½“å‰æ—¶é—´ä¸ºï¼š{{#1744185817604.date#}}ï¼‰`\n\
            \n- **ç«‹å³æ‰§è¡Œ**\n    - è‹¥`{query}`åŒ¹é…åˆ° `ç«‹å³æ‰§è¡Œ` ç­‰ç±»ä¼¼æè¿° â†’ `scheduleType = \"NONE\"\
            `\n\n- **æ— æ‰§è¡Œæ—¶é—´ç›¸å…³æè¿°**\n    - è‹¥`{query}`æ²¡æœ‰åŒ¹é…åˆ°ä»»ä½•æ‰§è¡Œæ—¶é—´ç›¸å…³æè¿° â†’ `scheduleType\
            \ = \"\"`\n\n- **æ—¶åŒºåˆ¤æ–­**\n    - è‹¥`{query}`åŒ¹é…åˆ° `è®¾å¤‡æ—¶é—´`ã€`è®¾å¤‡æ—¶åŒº` ç­‰ç±»ä¼¼æè¿° â†’ `timezone\
            \ = \"device\"`\n    - è‹¥`{query}`åŒ¹é…åˆ° `æœ¬åœ°æ—¶é—´`ã€`æœ¬åœ°æ—¶åŒº` ç­‰ç±»ä¼¼æè¿° â†’ `timezone =\
            \ \"local\"`\n    - è‹¥`{query}`æ²¡æœ‰åŒ¹é…åˆ°ä»¥ä¸Šä¸¤ç§æ—¶åŒºç›¸å…³æè¿° â†’ `timezone = \"\"`\n\n\
            ---\n\n### è®¾å¤‡ä¿¡æ¯åˆ†æ\n\n- **å¼‚å¸¸çŠ¶æ€åˆ†æï¼š**\n    - **assign_error**ï¼šå½“`{query}`åŒ¹é…åˆ°`å¼‚å¸¸`ã€`é”™è¯¯`ç­‰ç±»ä¼¼æè¿°æ—¶ï¼Œè®¾ç½®\
            \ `assign_error = true`\n    - **assign_offline**ï¼šå½“`{query}`åŒ¹é…åˆ° `ä¸Šä¸‹çº¿å¼‚å¸¸`ã€`ç¦»çº¿(Offline)`ã€`æ–­çº¿ä¸­(Disconnected)`æ—¶ï¼Œè®¾ç½®\
            \ `assign_offline = true`\n    - **assign_hardware**ï¼šå½“`{query}`åŒ¹é…åˆ° `ç¡¬ä»¶å¼‚å¸¸`\
            \ æ—¶ï¼Œè®¾ç½® `assign_hardware = true`\n    - **assign_software**ï¼šå½“`{query}`åŒ¹é…åˆ°\
            \ `è½¯ä»¶å¼‚å¸¸` æ—¶ï¼Œè®¾ç½® `assign_software = true`\n    - **assign_battery**ï¼šå½“`{query}`åŒ¹é…åˆ°\
            \ `ç”µæ± å¼‚å¸¸` æ—¶ï¼Œè®¾ç½® `assign_battery = true`\n    - **assign_peripheral**ï¼šå½“`{query}`åŒ¹é…åˆ°\
            \ `å‘¨è¾¹å¤–è®¾å¼‚å¸¸` æ—¶ï¼Œè®¾ç½® `assign_peripheral = true`\n    - **assign_security**ï¼šå½“`{query}`åŒ¹é…åˆ°\
            \ `è®¾å¤‡å®‰å…¨å¼‚å¸¸` æ—¶ï¼Œè®¾ç½® `assign_security = true`\n\n- **å¼‚å¸¸æ—¶é—´åˆ†æï¼š**\n    - å¦‚æœ`{query}`æ–‡æœ¬ä¸­åŒ¹é…åˆ°è¯¸å¦‚`å½“å‰`ã€`ç›®å‰`ã€`å½“ä¸‹`ã€`ç°åœ¨`ç­‰è¡¨ç¤ºå½“å‰æ—¶é—´çš„è¯æ—¶ï¼Œåˆ™è®¾ç½®\
            \ `assign_now = true`\n    - å¦‚æœ`{query}`æ–‡æœ¬ä¸­åŒ¹é…åˆ°è¯¸å¦‚`æœ€è¿‘`ã€`è¿‘æ—¥`ç­‰è¡¨ç¤ºæ¨¡ç³Šæ—¶é—´çš„è¯æ—¶ï¼Œåˆ™è®¾ç½®\
            \ `assign_now = false`\n    - å¦‚æœ`{query}`æ–‡æœ¬ä¸­åŒ¹é…åˆ°è¯¸å¦‚`è¿‘ä¸€ä¸ªæœˆ`ã€`æœ€è¿‘ä¸€å‘¨`ã€`å‰5å¤©`ç­‰è¡¨ç¤ºå…·ä½“æ—¶é—´çš„è¯æ—¶:\n\
            \        - è¯·æ ¹æ®å½“å‰æ—¶é—´ï¼ˆ`{{#1744185817604.date#}}`ï¼‰ï¼Œè®¡ç®—å‡ºå¼€å§‹æ—¥æœŸå’Œç»“æŸæ—¥æœŸï¼Œå¹¶è®¾ç½® `start_date\
            \ = å¼€å§‹æ—¥æœŸï¼ˆæ ¼å¼ï¼šYYYY/MM/DDï¼‰; end_date = ç»“æŸæ—¥æœŸï¼ˆæ ¼å¼ï¼šYYYY/MM/DDï¼‰`\n        - è®¾ç½®\
            \ `assign_time = true`\n\n- **åœ¨çº¿çŠ¶æ€åˆ†æï¼š**\n    - **assign_online**: å½“`{query}`åŒ¹é…åˆ°`åœ¨çº¿(Online)`ã€`çº¿ä¸Š`ç­‰ç±»ä¼¼æè¿°æ—¶ï¼Œè®¾ç½®\
            \ `assign_online = true`\n\n- **å­—æ®µæå–ï¼ˆæ‰€æœ‰å­—æ®µå‡è¿”å›æ•°ç»„ï¼›è‹¥æ— åŒ¹é…è¿”å›ç©ºæ•°ç»„ï¼‰ï¼š**\n    - **IDå­—æ®µ\
            \ (`id`)ï¼š**\n        - åœ¨`{query}`æ–‡æœ¬ä¸­**ç²¾ç¡®åŒ¹é…** `{{#1744185817604.id#}}`\
            \ å†…çš„ä»»ä¸€å…ƒç´ ï¼Œå°†æ‰€æœ‰åŒ¹é…é¡¹å­˜å…¥ `id` å­—æ®µã€‚\n    - **åç§°å­—æ®µ (`name`)ï¼š**\n        - åœ¨`{query}`æ–‡æœ¬ä¸­**ç²¾ç¡®åŒ¹é…**\
            \ `{{#1744185817604.name#}}` å†…çš„ä»»ä¸€å…ƒç´ ï¼Œå°†æ‰€æœ‰åŒ¹é…é¡¹å­˜å…¥ `name` å­—æ®µã€‚\n    - **IPå­—æ®µ\
            \ (`ip`)ï¼š**\n        - åœ¨`{query}`æ–‡æœ¬ä¸­**ç²¾ç¡®åŒ¹é…** `{{#1744185817604.ip#}}`\
            \ å†…çš„ä»»ä¸€å…ƒç´ ï¼Œå°†æ‰€æœ‰åŒ¹é…é¡¹å­˜å…¥ `ip` å­—æ®µã€‚\n    - **æ“ä½œç³»ç»Ÿå­—æ®µ (`os`)ï¼š**\n        - æ£€æŸ¥`{query}`æ–‡æœ¬ä¸­æ˜¯å¦åŒ…å«ä¸‹åˆ—å…³é”®è¯æˆ–å…¶åŒä¹‰è¯ï¼Œè‹¥åŒ¹é…åˆ™å°†å¯¹åº”çš„æ“ä½œç³»ç»Ÿå­˜å…¥\
            \ `os` å­—æ®µï¼š\n            - **windows**ï¼šå…³é”®è¯åŒ…æ‹¬ `windows`ã€`win`ã€`è§†çª—`ï¼›\n  \
            \          - **android**ï¼šå…³é”®è¯åŒ…æ‹¬ `android`ã€`å®‰å“`ï¼›\n            - **linux**ï¼šå…³é”®è¯åŒ…æ‹¬\
            \ `linux`ã€`linuxç³»ç»Ÿ`ã€‚\n        - **ç¤ºä¾‹ï¼š**\n            - å¯¹äºæ–‡æœ¬`è¯·å°†å®‰å“è®¾å¤‡é™éŸ³`ï¼Œåˆ™\
            \ `os` æå–ä¸º `[\"android\"]`ï¼›\n            - å¯¹äºæ–‡æœ¬`è¯·å°†winè®¾å¤‡é™éŸ³`ï¼Œåˆ™ `os` æå–ä¸º\
            \ `[\"windows\"]`ã€‚\n    - **æ ‡ç­¾1å­—æ®µ (`label1`)ï¼š**\n        - åœ¨`{query}`æ–‡æœ¬ä¸­**ç²¾ç¡®åŒ¹é…**\
            \ `{{#1744185817604.label1#}}` å†…çš„ä»»ä¸€å…ƒç´ ï¼Œå°†æ‰€æœ‰åŒ¹é…é¡¹å­˜å…¥ `label1` å­—æ®µã€‚\n    - **æ ‡ç­¾2å­—æ®µ\
            \ (`label2`)ï¼š**\n        - åœ¨`{query}`æ–‡æœ¬ä¸­**ç²¾ç¡®åŒ¹é…** `{{#1744185817604.label2#}}`\
            \ å†…çš„ä»»ä¸€å…ƒç´ ï¼Œå°†æ‰€æœ‰åŒ¹é…é¡¹å­˜å…¥ `label2` å­—æ®µã€‚\n\n- **æ ¹æ®`{query}`å†…å®¹ï¼Œç¡®å®šæ¡ä»¶æ ‡è®°ï¼š**\n    - **IDæ ‡è®°\
            \ (`assign_id`)**: å½“`{query}`åŒ¹é…åˆ° `è®¾å¤‡IDä¸º...` æˆ– `IDä¸º...` ç­‰æ˜ç¡®æŒ‡å®šIDæ ä½çš„æè¿°æ—¶ï¼Œè®¾ç½®\
            \ `assign_id = true`ï¼›\n    - **åç§°æ ‡è®° (`assign_name`)**: å½“`{query}`åŒ¹é…åˆ° `è®¾å¤‡åç§°ä¸º...`\
            \ æˆ– `åä¸º...` ç­‰æ˜ç¡®æŒ‡å®šåç§°æ ä½çš„æè¿°æ—¶ï¼Œè®¾ç½® `assign_name = true`ï¼›\n    - **IPæ ‡è®° (`assign_ip`)**:\
            \ å½“`{query}`åŒ¹é…åˆ° `è®¾å¤‡IPä¸º...`ã€`IPä¸º...` ç­‰æ˜ç¡®æŒ‡å®šIPæ ä½çš„æè¿°æ—¶ï¼Œè®¾ç½®`assign_ip = true`\n\
            \    - **ç³»ç»Ÿæ ‡è®° (`assign_os`)**: å½“`{query}`åŒ¹é…åˆ° `OSä¸º...` æˆ– `ç³»ç»Ÿä¸º...` ç­‰æ˜ç¡®æŒ‡å®šç³»ç»Ÿæ ä½çš„æè¿°æ—¶ï¼Œè®¾ç½®\
            \ `assign_os = true`ï¼›\n    - **æ ‡ç­¾1æ ‡è®° (`assign_label1`)**: å½“`{query}`åŒ¹é…åˆ°\
            \ `æ ‡ç­¾1ä¸º...` æˆ– `æ ‡ç­¾ä¸º...` ç­‰æ˜ç¡®æŒ‡å®šæ ‡ç­¾1æ ä½çš„æè¿°æ—¶ï¼Œè®¾ç½® `assign_label1 = true`ï¼›\n   \
            \ - **æ ‡ç­¾2æ ‡è®° (`assign_label2`)**: å½“`{query}`åŒ¹é…åˆ° `æ ‡ç­¾2ä¸º...` æˆ– `æ ‡ç­¾ä¸º...` ç­‰æ˜ç¡®æŒ‡å®šæ ‡ç­¾2æ ä½çš„æè¿°æ—¶ï¼Œè®¾ç½®\
            \ `assign_label2 = true`ï¼›\n\n- **ä¸‹æ ‡åˆ¤æ–­ï¼š**\n    - å¦‚æœ`{query}`æ–‡æœ¬ä¸­åŒ¹é…åˆ°è¯¸å¦‚ `ç¬¬ä¸€ä¸ª`ã€`ç¬¬äºŒä¸ª`\
            \ ç­‰æŒ‡ä»£ä¸‹æ ‡çš„è¯æ—¶ï¼Œåˆ™è®¾ç½® `assign_index = ç›¸åº”çš„æ•°å­—`ã€‚\n    - å¦‚æœ`{query}`æ–‡æœ¬ä¸­åŒ¹é…åˆ°è¯¸å¦‚ `æœ€å`ã€`å€’æ•°`\
            \ ç­‰æŒ‡ä»£åè½¬çš„è¯æ—¶ï¼Œåˆ™è®¾ç½® `assign_last = true`ã€‚\n\n---\n\n## è¾“å‡ºæ ¼å¼\nè¾“å‡º JSON æ ¼å¼å¿…é¡»ç¬¦åˆä»¥ä¸‹ç»“æ„ï¼š\n\
            ```json\n{\n  \"lang\": \"<zh-CN | zh-TW | ja-JP | en-US>\",\n  \"actionCode\"\
            : \"<90021 | 90022 | 90071 | 90081ï¼Œå­—ç¬¦ä¸²>\",\n  \"is_trigger\": \"<boolean>\"\
            ,\n  \"schedule\": {\n    \"scheduleType\": \"<'ONLINE' | 'CRON ONCE'\
            \ | 'NONE' | ''>\",\n    \"scheduleCron\": \"<æ—¶é—´å­—ç¬¦ä¸²ï¼Œæ ¼å¼ YYYY/MM/DD HH:mm:ss>\"\
            ,\n    \"timezone\": \"<'device' | 'local' | ''>\"\n  },\n  \"targetDevices\"\
            : {\n    \"assign_error\": \"<boolean>\",\n    \"assign_up_down\": \"\
            <boolean>\",\n    \"assign_hardware\": \"<boolean>\",\n    \"assign_software\"\
            : \"<boolean>\",\n    \"assign_battery\": \"<boolean>\",\n    \"assign_peripheral\"\
            : \"<boolean>\",\n    \"assign_security\": \"<boolean>\",\n    \"assign_now\"\
            : \"<boolean>\",\n    \"start_date\": \"<æ—¥æœŸå­—ç¬¦ä¸²ï¼Œæ ¼å¼ YYYY/MM/DD>\",\n   \
            \ \"end_date\": \"<æ—¥æœŸå­—ç¬¦ä¸²ï¼Œæ ¼å¼ YYYY/MM/DD>\",\n    \"assign_time\": \"<boolean>\"\
            ,\n    \"id\": \"<æ•°ç»„>\",\n    \"name\": \"<æ•°ç»„>\",\n    \"ip\": \"<æ•°ç»„>\"\
            ,\n    \"os\": \"<æ•°ç»„ï¼Œwindows | android | linux>\",\n    \"label1\": \"\
            <æ•°ç»„>\",\n    \"label2\": \"<æ•°ç»„>\",\n    \"assign_id\": \"<boolean>\",\n\
            \    \"assign_name\": \"<boolean>\",\n    \"assign_ip\": \"<boolean>\"\
            ,\n    \"assign_os\": \"<boolean>\",\n    \"assign_label1\": \"<boolean>\"\
            ,\n    \"assign_label2\": \"<boolean>\",\n    \"assign_online\": \"<boolean>\"\
            ,\n    \"assign_offline\": \"<boolean>\",\n    \"assign_index\": \"<number,\
            \ é»˜è®¤ä¸º-1>\",\n    \"assign_last\": \"<boolean>\"\n  }\n}\n```\n\n---\n"
        - id: 464731cd-cc5d-4854-9b1c-976a3bd8e616
          role: user
          text: '{{#context#}}'
        selected: false
        title: LLM OTA è®¾å¤‡ä¸ä»»åŠ¡å‚æ•°
        type: llm
        variables: []
        vision:
          enabled: false
      height: 90
      id: '1744186341974'
      position:
        x: 942.757858283255
        y: 310
      positionAbsolute:
        x: 942.757858283255
        y: 310
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        code: "function handleLLM(text) {\n  const regex = /```json([\\s\\S]*?)```/\n\
          \  const _res = text.replaceAll(/<think>[\\s\\S]*?<\\/think>/g, '')\n  const\
          \ match = _res.match(regex);\n  const res = !!match ? match[1].trim() :\
          \ _res\n  const str = res.replaceAll(/\\/\\/.*$/gm, '').replaceAll(/\\/\\\
          *[\\s\\S]*?\\*\\//g, '')\n  let obj\n  try {\n    obj = JSON.parse(str)\n\
          \  } catch (e) {\n    obj = {}\n  }\n  return obj\n}\nfunction convertToTimeZone(timezone)\
          \ {\n  // æ£€æŸ¥æ ¼å¼æ˜¯å¦ä»¥ \"UTC\" å¼€å¤´\n  if (!timezone.startsWith(\"UTC\")) {\n \
          \   throw new Error(\"æ—¶åŒºæ ¼å¼å¿…é¡»ä»¥ 'UTC' å¼€å¤´\");\n  }\n  // è·å–ç¬¦å·å’Œå°æ—¶ã€åˆ†é’Ÿéƒ¨åˆ†\n  const\
          \ sign = timezone[3]; // '+' æˆ– '-'\n  if (sign !== '+' && sign !== '-')\
          \ {\n    throw new Error(\"æ— æ•ˆçš„æ—¶åŒºæ ¼å¼\");\n  }\n  const hourStr = timezone.substr(4,\
          \ 2);\n  const minuteStr = timezone.substr(7, 2);\n  const offsetHours =\
          \ parseInt(hourStr, 10);\n  const offsetMinutes = parseInt(minuteStr, 10);\n\
          \  // è®¡ç®—æ€»åç§»åˆ†é’Ÿæ•°ï¼ˆæ­£å€¼ä»£è¡¨æ¯” UTC æ™šï¼Œè´Ÿå€¼ä»£è¡¨æ¯” UTC æ—©ï¼‰\n  let totalOffset = offsetHours\
          \ * 60 + offsetMinutes;\n  if (sign === '-') {\n    totalOffset = -totalOffset;\n\
          \  }\n  // å½“å‰çš„ UTC æ¯«ç§’æ•°ï¼ˆDate.now() è¿”å›çš„æ˜¯è‡ª1970å¹´1æœˆ1æ—¥ UTC ä»¥æ¥çš„æ¯«ç§’æ•°ï¼‰\n  const nowMs\
          \ = Date.now();\n  // ç›®æ ‡æ—¶åŒºçš„æ¯«ç§’æ•° = å½“å‰ UTC æ¯«ç§’æ•° + æ—¶åŒºåç§»åˆ†é’Ÿæ•°è½¬æ¢ä¸ºæ¯«ç§’\n  const targetMs\
          \ = nowMs + totalOffset * 60000;\n  const targetDate = new Date(targetMs);\n\
          \  // ä½¿ç”¨ getUTC* æ–¹æ³•æ¥æå–ç›®æ ‡æ—¶åŒºçš„å„éƒ¨åˆ†\n  const year = targetDate.getUTCFullYear();\n\
          \  const month = String(targetDate.getUTCMonth() + 1).padStart(2, '0');\
          \ // æœˆä»½ä» 0 å¼€å§‹\n  const day = String(targetDate.getUTCDate()).padStart(2,\
          \ '0');\n  const hours = String(targetDate.getUTCHours()).padStart(2, '0');\n\
          \  const minutes = String(targetDate.getUTCMinutes()).padStart(2, '0');\n\
          \  const seconds = String(targetDate.getUTCSeconds()).padStart(2, '0');\n\
          \n  return `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;\n}\n\
          function filterDevice(device, llm_result, type, content, api, token, question,\
          \ timezone, flow) {\n  // å¤„ç†è®¾å¤‡\n  const device_list = Array.isArray(device)\
          \ ? Array.from(device) : []\n  const device_by_id = {}\n  device_list.forEach(o\
          \ => {\n    device_by_id[o.id] = o\n  })\n\n  const lang = String(llm_result?.lang\
          \ ?? '')\n  // è®¾å¤‡å¼‚å¸¸ç›¸å…³å˜é‡\n  const is_error = !!llm_result?.targetDevices?.assign_error\n\
          \  const assign_offline = !!llm_result?.targetDevices?.assign_offline\n\
          \  const assign_hardware = !!llm_result?.targetDevices?.assign_hardware\n\
          \  const assign_software = !!llm_result?.targetDevices?.assign_software\n\
          \  const assign_battery = !!llm_result?.targetDevices?.assign_battery\n\
          \  const assign_peripheral = !!llm_result?.targetDevices?.assign_peripheral\n\
          \  const assign_security = !!llm_result?.targetDevices?.assign_security\n\
          \  const assign_now = !!llm_result?.targetDevices?.assign_now\n  const assign_error\
          \ = is_error && !assign_offline && !assign_hardware && !assign_software\
          \ && !assign_battery && !assign_peripheral && !assign_security\n  const\
          \ has_error = assign_error || assign_offline || assign_hardware || assign_software\
          \ || assign_battery || assign_peripheral || assign_security\n\n  // ç­›é€‰è®¾å¤‡\n\
          \  let filter = [], request = '', is_find_device = 1\n  // å¦‚æœæ²¡æœ‰æ¶‰åŠå¼‚å¸¸æˆ–è€…åªæ¶‰åŠå½“å‰çš„å¼‚å¸¸æ—¶ï¼Œåªéœ€è¦ä»è®¾å¤‡åˆ—è¡¨è¿›è¡Œç­›é€‰å°±å¯ä»¥\n\
          \  if (!has_error || (has_error && assign_now)) {\n    // è®¾å¤‡å±æ€§ç­›é€‰ç›¸å…³å˜é‡\n \
          \   const id = Array.isArray(llm_result?.targetDevices?.id) ? Array.from(llm_result.targetDevices.id)\
          \ : []\n    const name = Array.isArray(llm_result?.targetDevices?.name)\
          \ ? Array.from(llm_result.targetDevices.name) : []\n    const ip = Array.isArray(llm_result?.targetDevices?.ip)\
          \ ? Array.from(llm_result.targetDevices.ip) : []\n    const os = Array.isArray(llm_result?.targetDevices?.os)\
          \ ? Array.from(llm_result.targetDevices.os).map(s => String(s).toLowerCase())\
          \ : []\n    const label1 = Array.isArray(llm_result?.targetDevices?.label1)\
          \ ? Array.from(llm_result.targetDevices.label1) : []\n    const label2 =\
          \ Array.isArray(llm_result?.targetDevices?.label2) ? Array.from(llm_result.targetDevices.label2)\
          \ : []\n    const assign_id = !!llm_result?.targetDevices?.assign_id\n \
          \   const assign_name = !!llm_result?.targetDevices?.assign_name\n    const\
          \ assign_ip = !!llm_result?.targetDevices?.assign_ip\n    const assign_os\
          \ = !!llm_result?.targetDevices?.assign_os\n    const assign_label1 = !!llm_result?.targetDevices?.assign_label1\n\
          \    const assign_label2 = !!llm_result?.targetDevices?.assign_label2\n\
          \    const assign_online = !!llm_result?.targetDevices?.assign_online\n\
          \    const assign_index = Number(llm_result?.targetDevices?.assign_index)\n\
          \    let not_prop = id.length === 0 && name.length === 0 && ip.length ===\
          \ 0 && os.length === 0 && label1.length === 0 && label2.length === 0\n \
          \   let has_prop = assign_id || assign_name || assign_ip || assign_os ||\
          \ assign_label1 || assign_label2\n    let use_cache = not_prop && !has_prop\
          \ && !assign_online && !has_error\n    if (flow === 'remote_desktop') {\n\
          \      not_prop = id.length === 0 && name.length === 0 && ip.length ===\
          \ 0\n      has_prop = assign_id || assign_name || assign_ip\n      use_cache\
          \ = not_prop && !has_prop && !has_error\n    }\n    let filter_id = []\n\
          \    // å¤„ç†å·²å­˜åœ¨è®¾å¤‡ç­›é€‰ç»“æœçš„æƒ…å†µ\n    if (!!content && (type === 'find_device' ||\
          \ type === 'find_error')) {\n      const cache = JSON.parse(content)\n \
          \     let cache_device = Array.isArray(cache?.data?.targetDevices) ? Array.from(cache?.data?.targetDevices)\
          \ : []\n      cache_device = cache_device.filter(o => !!device_by_id[o.id]).map(o\
          \ => device_by_id[o.id])\n      // å¤„ç†ä½¿ç”¨ä¸‹æ ‡æŒ‡å®šè®¾å¤‡çš„æƒ…å†µ\n      const assign_last\
          \ = !!llm_result?.targetDevices?.assign_last\n      if (!Number.isNaN(assign_index)\
          \ && assign_index > 0 && assign_index <= cache_device.length) {\n      \
          \  let index = assign_index - 1\n        if (assign_last) index = cache_device.length\
          \ - 1 - index\n        filter_id = [cache_device[index].id]\n      }\n \
          \     else {\n        filter_id = cache_device.filter(o => {\n         \
          \ const match_id = id.includes(o.id)\n          const match_name = name.includes(o.nm)\n\
          \          const match_ip = ip.includes(o.ip)\n          const match_os\
          \ = os.includes(o.os)\n          const match_label1 = label1.includes(o.l1)\n\
          \          const match_label2 = label2.includes(o.l2)\n          // å½“æ²¡æœ‰æŒ‡å®šå…·ä½“æ ä½æ—¶ï¼Œåªè¦æ»¡è¶³ä¸€ä¸ªæ¡ä»¶å°±è¡Œ\n\
          \          if (!has_prop) {\n            if (flow === 'remote_desktop')\
          \ return match_id || match_name || match_ip\n            return match_id\
          \ || match_name || match_ip || match_os || match_label1 || match_label2\n\
          \          }\n          // å½“æœ‰æŒ‡å®šå…·ä½“æ ä½æ—¶ï¼Œéœ€è¦æ»¡è¶³æ‰€æœ‰æŒ‡å®šæ ä½\n          let match = true\n\
          \          if (assign_id) match = match && match_id\n          if (assign_name)\
          \ match = match && match_name\n          if (assign_ip) match = match &&\
          \ match_ip\n          if (flow === 'remote_desktop') return match\n    \
          \      if (assign_os) match = match && match_os\n          if (assign_label1\
          \ && !assign_label2) match = match && match_label1\n          if (!assign_label1\
          \ && assign_label2) match = match && match_label2\n          if (assign_label1\
          \ && assign_label2) match = match && (match_label2 || match_label1)\n  \
          \        return match\n        }).map(o => o.id)\n        if (filter_id.length\
          \ === 0 && use_cache && flow !== 'find_device') {\n          filter_id =\
          \ cache_device.map(o => o.id)\n        }\n      }\n    }\n    // å¦‚æœç»è¿‡ä¹‹å‰çš„ç­›é€‰åï¼Œç»“æœä»ç„¶ä¸ºç©ºï¼Œåˆ™ä»æ‰€æœ‰è®¾å¤‡ä¸­ç­›é€‰\n\
          \    if (filter_id.length === 0) {\n      filter_id = Object.values(device_by_id).filter(o\
          \ => {\n        const offline = Number(o.st) === 0\n        const hardware\
          \ = Number(o.hw) > 0\n        const software = Number(o.sw) > 0\n      \
          \  const battery = Number(o.bt) > 0\n        const peripheral = Number(o.pp)\
          \ > 0\n        const security = Number(o.hw) > 0\n        const match_error\
          \ = offline || hardware || software || battery || peripheral || security\n\
          \        let match = true\n\n        // å¤„ç†å¼‚å¸¸ç­›é€‰\n        if (assign_error)\
          \ match = match && match_error\n        if (assign_offline) match = match\
          \ && offline\n        if (assign_hardware) match = match && hardware\n \
          \       if (assign_software) match = match && software\n        if (assign_battery)\
          \ match = match && battery\n        if (assign_peripheral) match = match\
          \ && peripheral\n        if (assign_security) match = match && security\n\
          \        if (!match) return match\n\n        // å¤„ç†å±æ€§ç­›é€‰\n        const match_id\
          \ = id.includes(o.id)\n        const match_name = name.includes(o.nm)\n\
          \        const match_ip = ip.includes(o.ip)\n        const match_os = os.includes(o.os)\n\
          \        const match_label1 = label1.includes(o.l1)\n        const match_label2\
          \ = label2.includes(o.l2)\n        const match_online = assign_online &&\
          \ Number(o.st) === 1\n        const match_status = match_online || (!assign_online)\n\
          \        // å½“æ²¡æœ‰åŒ¹é…ä»»ä½•å±æ€§æ—¶ï¼Œåªç­›é€‰status\n        if (not_prop) return match_status\n\
          \        // å½“æ²¡æœ‰æŒ‡å®šå…·ä½“æ ä½æ—¶ï¼Œåªè¦æ»¡è¶³ä¸€ä¸ªæ¡ä»¶å°±è¡Œ\n        if (!has_prop) {\n          if\
          \ (flow === 'remote_desktop') return match_id || match_name || match_ip\n\
          \          return (match_id || match_name || match_ip || match_os || match_label1\
          \ || match_label2) && match_status\n        }\n        // å½“æœ‰æŒ‡å®šå…·ä½“æ ä½æ—¶ï¼Œéœ€è¦æ»¡è¶³æ‰€æœ‰æŒ‡å®šæ ä½\n\
          \        if (assign_id) match = match && match_id\n        if (assign_name)\
          \ match = match && match_name\n        if (assign_ip) match = match && match_ip\n\
          \        if (flow === 'remote_desktop') return match\n        match = match\
          \ && match_status\n        if (assign_os) match = match && match_os\n  \
          \      if (assign_label1 && !assign_label2) match = match && match_label1\n\
          \        if (!assign_label1 && assign_label2) match = match && match_label2\n\
          \        if (assign_label1 && assign_label2) match = match && (match_label2\
          \ || match_label1)\n        return match\n      }).map(o => o.id)\n    }\n\
          \    filter = filter_id.map(id => {\n      const o = device_by_id[id]\n\
          \      if (String(flow).endsWith('task')) {\n        return {\n        \
          \  id: o.id,\n          name: o.nm,\n          os: o.os,\n          timezone:\
          \ o.tz,\n        }\n      }\n      return {\n        id: o.id,\n       \
          \ name: o.nm,\n        os: o.os,\n        timezone: o.tz,\n        ip: o.ip,\n\
          \        status: o.st,\n      }\n    })\n    is_find_device = assign_index\
          \ !== -1 || !not_prop || assign_online || has_error ? 1 : 0\n  }\n  // å¦‚æœæ¶‰åŠä¹‹å‰çš„å¼‚å¸¸ï¼Œå°±éœ€è¦å†ç»“åˆäº‹ä»¶åˆ—è¡¨è¿›è¡Œç­›é€‰\n\
          \  else {\n    const assign_time = !!llm_result?.targetDevices?.assign_time\n\
          \    const start_date = String(llm_result?.targetDevices?.start_date ??\
          \ '')\n    const end_date = String(llm_result?.targetDevices?.end_date ??\
          \ '')\n    const zone = String(timezone).slice(3)\n    let sd = new Date(`${start_date}\
          \ 00:00:00${zone}`)\n    let ed = new Date(`${end_date} 00:00:00${zone}`)\n\
          \    if (!assign_time) {\n      const now = convertToTimeZone(timezone)\n\
          \      const dt = now.split(' ')[0]\n      ed = new Date(`${dt} 00:00:00${zone}`)\n\
          \      const arr = dt.split('/')\n      const day = Number(arr[2])\n   \
          \   let month = Number(arr[1]) - 4\n      let year = Number(arr[0])\n  \
          \    if (month < 0) {\n        month += 12\n        year -= 1\n      }\n\
          \      const last = new Date(year, month + 1, 0).getDate()\n      const\
          \ date = Math.min(day, last)\n      sd = new Date(`${year}/${month + 1}/${date}\
          \ 00:00:00${zone}`)\n    }\n    const start = sd.getTime()\n    const end\
          \ = ed.getTime() + (24 * 60 * 60 * 1000 - 1)\n    let range = [], params\
          \ = ''\n    if (assign_offline) range = range.concat('4')\n    if (assign_hardware)\
          \ range = range.concat('1')\n    if (assign_software) range = range.concat('2')\n\
          \    if (assign_battery) range = range.concat('6')\n    if (assign_peripheral)\
          \ range = range.concat('3')\n    if (assign_security) range = range.concat('7')\n\
          \    params = `?startTime=${start}&endTime=${end}`\n    range.forEach(item\
          \ => {\n      params += `&categoryRange=${item}`\n    })\n    request =\
          \ JSON.stringify({\n      inputs: {\n        params,\n        range: JSON.stringify(range),\n\
          \        lang,\n        device: JSON.stringify(device),\n        question,\n\
          \        api,\n        token\n      },\n      response_mode: 'blocking',\n\
          \      user: `deviceOn ${flow}`\n    })\n  }\n  return {\n    filter,\n\
          \    is_find_device,\n    lang,\n    request,\n  }\n}\nfunction main({text,\
          \ device, type, content, api, token, question, timezone}) {\n  // å¤„ç† LLM\
          \ ç»“æœ\n  const obj = handleLLM(text)\n  const actionCode = String(obj?.actionCode)\n\
          \n  const {\n    request,\n    filter,\n  } = filterDevice(JSON.parse(device),\
          \ obj, type, content, api, token, question, timezone, 'ota_task')\n  const\
          \ result = {\n    type: 'ota_task',\n    data: {\n      ...obj,\n      targetDevices:\
          \ !!request ? [] : filter,\n    },\n  }\n  const action = !!request ? 'filter_error'\
          \ : 'query_file'\n\n  let file_url = ''\n  switch (actionCode) {\n    case\
          \ '90021':\n    case '90022':\n      file_url = '/walle/ai/taskAssist/listSoftware'\n\
          \      break\n    case '90071':\n      file_url = '/walle/ai/taskAssist/listScript'\n\
          \      break\n    case '90081':\n      file_url = '/walle/ai/taskAssist/listFile'\n\
          \      break\n  }\n\n  return {\n    action,\n    actionCode,\n    result,\n\
          \    request,\n    file_url,\n  }\n\n}"
        code_language: javascript
        desc: ''
        outputs:
          action:
            children: null
            type: string
          actionCode:
            children: null
            type: string
          file_url:
            children: null
            type: string
          request:
            children: null
            type: string
          result:
            children: null
            type: object
        selected: true
        title: å¤„ç†è®¾å¤‡ä¸ä»»åŠ¡å‚æ•°
        type: code
        variables:
        - value_selector:
          - '1744186341974'
          - text
          variable: text
        - value_selector:
          - '1744185817604'
          - device
          variable: device
        - value_selector:
          - '1744019627790'
          - content
          variable: content
        - value_selector:
          - '1744019627790'
          - type
          variable: type
        - value_selector:
          - '1744019627790'
          - api
          variable: api
        - value_selector:
          - '1744019627790'
          - token
          variable: token
        - value_selector:
          - '1744019627790'
          - question
          variable: question
        - value_selector:
          - '1744019627790'
          - timezone
          variable: timezone
      height: 54
      id: '1744190704175'
      position:
        x: 1246
        y: 310
      positionAbsolute:
        x: 1246
        y: 310
      selected: true
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        code: "function main({body}) {\n  const obj = JSON.parse(body)\n  const permission\
          \ = Number(obj?.code) === 200 ? 1 : 0\n  const result = JSON.stringify({\n\
          \    type: 'ota_task',\n    step: 'no_permission'\n  })\n  return {\n  \
          \  permission,\n    result,\n    type: '',\n  }\n}"
        code_language: javascript
        desc: ''
        outputs:
          permission:
            children: null
            type: number
          result:
            children: null
            type: string
          type:
            children: null
            type: string
        selected: false
        title: å¤„ç†ç”¨æˆ·æƒé™
        type: code
        variables:
        - value_selector:
          - '1744262385871'
          - body
          variable: body
      height: 54
      id: '1744254606128'
      position:
        x: 1816.8649441204952
        y: 310
      positionAbsolute:
        x: 1816.8649441204952
        y: 310
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        cases:
        - case_id: 'true'
          conditions:
          - comparison_operator: '='
            id: c99271cb-310b-44ba-bc1b-bac66cce3671
            value: '0'
            varType: number
            variable_selector:
            - '1744254606128'
            - permission
          id: 'true'
          logical_operator: and
        - case_id: 94f2aeb0-7641-43af-9c3b-ab7b51e269a3
          conditions:
          - comparison_operator: is
            id: 47c95ccd-9417-42b2-9da5-4703962f2f06
            value: filter_error
            varType: string
            variable_selector:
            - '1744190704175'
            - action
          logical_operator: and
        desc: ''
        selected: false
        title: åˆ¤æ–­ç”¨æˆ·æƒé™
        type: if-else
      height: 174
      id: '1744255072161'
      position:
        x: 2100.402770472605
        y: 310
      positionAbsolute:
        x: 2100.402770472605
        y: 310
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        desc: ''
        outputs:
        - value_selector:
          - '1744254606128'
          - result
          variable: result
        - value_selector:
          - '1744254606128'
          - type
          variable: type
        selected: false
        title: è¿”å›æ•°æ®
        type: end
      height: 116
      id: '1744255120169'
      position:
        x: 2481.704315364635
        y: 100.0732555383101
      positionAbsolute:
        x: 2481.704315364635
        y: 100.0732555383101
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        authorization:
          config: null
          type: no-auth
        body:
          data:
          - id: key-value-35
            key: ''
            type: text
            value: '{{#1744190704175.request#}}'
          type: json
        desc: ''
        headers: 'Authorization:Bearer {{#env.filter_error#}}

          Content-Type:application/json'
        method: post
        params: ''
        retry_config:
          max_retries: 3
          retry_enabled: true
          retry_interval: 100
        selected: false
        timeout:
          max_connect_timeout: 0
          max_read_timeout: 0
          max_write_timeout: 0
        title: è®¾å¤‡å¼‚å¸¸ç­›é€‰
        type: http-request
        url: '{{#env.path#}}'
        variables: []
      height: 123
      id: '1744255571899'
      position:
        x: 2481.704315364635
        y: 310
      positionAbsolute:
        x: 2481.704315364635
        y: 310
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        code: "function main({result, body}) {\n  let device = result.data.targetDevices\n\
          \  if (!!body) {\n    const obj = JSON.parse(body)\n    const outputs =\
          \ obj?.data?.outputs ?? {}\n    const res = JSON.parse(outputs?.result ??\
          \ '{}')\n    device = Array.isArray(res?.data?.targetDevices) ? Array.from(res.data.targetDevices)\
          \ : []\n  }\n  const new_obj = {\n    type: 'ota_task',\n    data: {\n \
          \     ...result.data,\n      targetDevices: device\n    }\n  }\n\n  return\
          \ {\n    result: new_obj,\n  }\n}"
        code_language: javascript
        desc: ''
        outputs:
          result:
            children: null
            type: object
        selected: false
        title: å¤„ç†è®¾å¤‡å¼‚å¸¸ç­›é€‰
        type: code
        variables:
        - value_selector:
          - '1744190704175'
          - result
          variable: result
        - value_selector:
          - '1744255571899'
          - body
          variable: body
      height: 54
      id: '1744255807610'
      position:
        x: 2785.7043153646355
        y: 452.94352695304724
      positionAbsolute:
        x: 2785.7043153646355
        y: 452.94352695304724
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        authorization:
          config: null
          type: no-auth
        body:
          data: []
          type: none
        desc: ''
        headers: Authorization:{{#1744019627790.token#}}
        method: get
        params: ''
        retry_config:
          max_retries: 3
          retry_enabled: true
          retry_interval: 100
        selected: false
        timeout:
          max_connect_timeout: 0
          max_read_timeout: 0
          max_write_timeout: 0
        title: ç”¨æˆ· OTA æƒé™
        type: http-request
        url: '{{#1744019627790.api#}}/walle/ai/taskAssist/auth/{{#1744190704175.actionCode#}}'
        variables: []
      height: 158
      id: '1744262385871'
      position:
        x: 1533.3271177683855
        y: 310
      positionAbsolute:
        x: 1533.3271177683855
        y: 310
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        authorization:
          config: null
          type: no-auth
        body:
          data: []
          type: none
        desc: ''
        headers: Authorization:{{#1744019627790.token#}}
        method: get
        params: ''
        retry_config:
          max_retries: 3
          retry_enabled: true
          retry_interval: 100
        selected: false
        timeout:
          max_connect_timeout: 0
          max_read_timeout: 0
          max_write_timeout: 0
        title: è½¯ä»¶/è„šæœ¬/æ¡£æ¡ˆåˆ—è¡¨
        type: http-request
        url: '{{#1744019627790.api#}}{{#1744190704175.file_url#}}'
        variables: []
      height: 142
      id: '1744265799521'
      position:
        x: 3072.2735748497657
        y: 452.94352695304724
      positionAbsolute:
        x: 3072.2735748497657
        y: 452.94352695304724
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        code: "function main({result, body, question}) {\n  const obj = JSON.parse(body)\n\
          \  let list = Array.isArray(obj?.rows) ? Array.from(obj.rows) : []\n  list\
          \ = list.concat(Array.isArray(obj?.data?.tenantSoftwareList) ? Array.from(obj.data.tenantSoftwareList)\
          \ : [])\n  list = list.concat(Array.isArray(obj?.data?.systemSoftwareList)\
          \ ? Array.from(obj.data.systemSoftwareList) : [])\n  const query = String(question)\n\
          \  const actionCode = String(result?.data?.actionCode)\n  const device =\
          \  Array.isArray(result?.data?.targetDevices) ? Array.from(result?.data?.targetDevices)\
          \ : []\n  let target = [], osType = '',  step = 'select_target', fail =\
          \ [], target_len = 0\n  // æ ¹æ®è®¾å¤‡è·å–os\n  const oses = device.map(o => o.os)\n\
          \  if (oses.length === 1) osType = oses[0]\n  // ç­›é€‰è½¯ä»¶ã€è„šæœ¬ã€æ¡£æ¡ˆ\n  switch (actionCode)\
          \ {\n    case '90021':\n    case '90022':\n      target = list.filter(o\
          \ => {\n        return query.includes(o?.['softwareName'])\n      })\n \
          \     target_len = target.length\n      const sf_ok = o => Array.isArray(o?.pkgList)\
          \ && Array.from(o?.pkgList).length > 0\n      if (target.length > 0) {\n\
          \        fail = target.filter(o => !sf_ok(o))\n        const ok = target.filter(o\
          \ => sf_ok(o))\n        if (ok.length > 0) {\n          const oses = ok.map(o\
          \ => o?.osType)\n          if (oses.length === 1) osType = oses[0]\n   \
          \       target = ok.map(o => {\n            return {\n              id:\
          \ o?.['repoId'],\n              name: o?.['softwareName'],\n           \
          \   os: o?.osType,\n            }\n          })\n          if (!!osType)\
          \ step = 'confirm_target'\n        } else {\n          const oses = fail.map(o\
          \ => o.osType)\n          if (oses.length === 1) osType = oses[0]\n    \
          \    }\n      }\n      if (target.length === 0) {\n        target = list.filter(o\
          \ => sf_ok(o) && (!osType || osType === o?.osType)).map(o => {\n       \
          \   return {\n            id: o?.['repoId'],\n            name: o?.['softwareName'],\n\
          \            os: o?.osType,\n          }\n        })\n      }\n      break\n\
          \    case '90071':\n      target = list.filter(o => {\n        return query.includes(o?.['srName'])\n\
          \      })\n      target_len = target.length\n      const sr_ok = o => Array.isArray(o?.scriptPkgList)\
          \ && Array.from(o?.scriptPkgList).length > 0\n      if (target.length >\
          \ 0) {\n        fail = target.filter(o => !sr_ok(o))\n        const ok =\
          \ target.filter(o => sr_ok(o))\n        if (ok.length > 0) {\n         \
          \ const oses = ok.map(o => o?.osType)\n          if (oses.length === 1)\
          \ osType = oses[0]\n          target = ok.map(o => {\n            return\
          \ {\n              id: o?.['srId'],\n              name: o?.['srName'],\n\
          \              os: o?.osType,\n            }\n          })\n          if\
          \ (!!osType && target.length === 1) step = 'confirm_target'\n        } else\
          \ {\n          const oses = fail.map(o => o.osType)\n          if (oses.length\
          \ === 1) osType = oses[0]\n        }\n      }\n      if (target.length ===\
          \ 0) {\n        target = list.filter(o => sr_ok(o) && (!osType || osType\
          \ === o?.osType)).map(o => {\n          return {\n            id: o?.['srId'],\n\
          \            name: o?.['srName'],\n            os: o?.osType,\n        \
          \  }\n        })\n      }\n      break\n    case '90081':\n      target\
          \ = list.filter(o => {\n        return query.includes(o?.['frName'])\n \
          \     })\n      target_len = target.length\n      const fr_ok = o => Array.isArray(o?.filePkgList)\
          \ && Array.from(o?.filePkgList).length > 0\n      if (target.length > 0)\
          \ {\n        fail = target.filter(o => !fr_ok(o))\n        const ok = target.filter(o\
          \ => fr_ok(o))\n        if (ok.length > 0) {\n          const oses = ok.map(o\
          \ => o?.osType)\n          if (oses.length === 1) osType = oses[0]\n   \
          \       target = ok.map(o => {\n            return {\n              id:\
          \ o?.['frId'],\n              name: o?.['frName'],\n              os: o?.osType,\n\
          \            }\n          })\n          if (!!osType && target.length ===\
          \ 1) step = 'confirm_target'\n        } else {\n          const oses = fail.map(o\
          \ => o.osType)\n          if (oses.length === 1) osType = oses[0]\n    \
          \    }\n      }\n      if (target.length === 0) {\n        target = list.filter(o\
          \ => fr_ok(o) && (!osType || osType === o?.osType)).map(o => {\n       \
          \   return {\n            id: o?.['frId'],\n            name: o?.['frName'],\n\
          \            os: o?.osType,\n          }\n        })\n      }\n      break\n\
          \  }\n  const res = JSON.stringify({\n    type: 'ota_task',\n    step,\n\
          \    data: {\n      ...result.data,\n      osType,\n      target,\n    \
          \  target_len,\n      fail,\n    }\n  })\n\n  return {\n    result: res,\n\
          \    type: 'ota_task',\n  }\n}"
        code_language: javascript
        desc: ''
        outputs:
          result:
            children: null
            type: string
          type:
            children: null
            type: string
        selected: false
        title: å¤„ç†è½¯ä»¶/è„šæœ¬/æ¡£æ¡ˆ
        type: code
        variables:
        - value_selector:
          - '1744265799521'
          - body
          variable: body
        - value_selector:
          - '1744255807610'
          - result
          variable: result
        - value_selector:
          - '1744019627790'
          - question
          variable: question
      height: 54
      id: '1744265933431'
      position:
        x: 3376.2735748497657
        y: 452.94352695304724
      positionAbsolute:
        x: 3376.2735748497657
        y: 452.94352695304724
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        desc: ''
        outputs:
        - value_selector:
          - '1744265933431'
          - result
          variable: result
        - value_selector:
          - '1744265933431'
          - type
          variable: type
        selected: false
        title: è¿”å›æ•°æ®
        type: end
      height: 116
      id: '1744268747197'
      position:
        x: 3673.4528503004685
        y: 452.94352695304724
      positionAbsolute:
        x: 3673.4528503004685
        y: 452.94352695304724
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    viewport:
      x: -729.0143923149708
      y: -3.9559598524932653
      zoom: 1.1486983549970364
